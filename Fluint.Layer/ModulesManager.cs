// ::::;;,,,............,oxddddolodxxxkkxo::cldddoc;,,;clodo:...,llll:;cloooodooxxdc'......',;;:::llllcccl:.....'ldo,,okxxo:,,,;;,'',;:looddxxxddddoooolllccccc:::::;;;;;,,,',codxxkkkkOOOOOOOOOOOOOOOOOkkk
// ::::;;;,,............,oxdxxxxdxxkkkkxdl;,:lddlc:;'..,:codc...'clll:;cllooodoodl,........',;:;,,coollccl:.....'ldo;,lkkxl;,,,;;,'',;:clooddxddddoooooollcccc::::;;;;;;;,,,,;lddxxkkkkOOOOOOOOOOOkkkOOOOOO
// :::::;;,,............:xxxxxxxxkkkxxxddol:;clc;;cc:,',:lodl,.',clloc:cllooodoc,.. .',....';;,',:looollllc'....,loo:'lkkxl;;,,;;,''';:cllodddddoooooooolllcc:::;;;;;;;;;,,,:ldxxxkkkkOOOOOOOkkxxxdxxxxxkkk
// cc::::;;,...........'lxkkkkkkkkkxxxxxxxdc;:clodxxdl;,;cldo;',,clodl:cllooodl'.....,;,...,,'',;cllooollll,....,lddc,cxkdc;;,,,,,''',;clloooooooooooooollllcc:;;;;,,;;;;,;codxxkkkkkOOOOkkdddxxxxxkkkkkkxx
// ccc:::;;,...........'lxkkkkkkkkxxxdddxxxdlldddddxxdlccclddc,,;coodl:cllloddc.....,,,,'....,;;;clllooolol,....,lkko,cdoc;;;,,,,,''',;:clooooooooooooooollllc:;;,,,,,,,;codddxkkkkkOOOOkxdodxxkxxxxxkkkkkk
// cccc::;;,.......''..,oxxxxxxxxddollooddddoodxddddxdooolcoxo;,;cdddoccoooodo;.....';;::::,.,;,;::;,:llloo;....,lxkl'.''',;;,,,,,'''';:clllllloooooooooooollc:;;,,,',,,:lddddxkkkkkOOOOkxdxxxxdoooddxxxkkk
// ccccc:;;,.......'...,lddoloooccc::cloolcloooolcclddoc::cldo:;;cdddoclodddxo;''...,:clcccl:'.......,clloo;.....,c:'..,ll;;;,,,,,,''',:lllccclloooooooooolllc:;;,'''',,;ldddxkkxkkkOOOkxxxxxdoodxxxxxxxxkk
// ccccc::;,.....',;,..,looooolc::cccclodxxxoc::;,,coddl:::ldxc;:coddoccodddxd:''..,''',;clo:. ......,clool;....':ddc.,dkd:;;,,,,,,''',:cllcccclooooooooollcccc:;,''',,,:lxdodxxdxxkkOOkxdxxxoldkkkkxxxxkkk
// ccccc::;,....'';;,'.,looddolccldoc:loddddl;;;;;;coooollloxxc;;codddccodddxxc,,.';;'...',,.....''',cooooo,...''ckko;lkkxc;;,,,,,,''',:cllc:ccllooooooolllcccc:,'''',,;;:c:;;cccldxkkOkdddxxdoodxxkkxxkkkk
// cccc:::;,...'',;,''.;lloddoloooxdc;clllccc::;;:clodddoloddo:;;:odddlcodddxxo;,..;:..',,.. ....''';looodo;...'':xkc:dkkxc;;,',,,,''',:clcc:cllllloooolllcccc:;,'..',,''''...'''':oxkkkxddxxkxxdxxkkkkkkkk
// cccc:::;,...'',;,'..;lddollccodxdc;:clccclc::;cooddoollodddl;;:ldddlcodddxxo:,'.',..',,. ......';loooodo;.....'::'':cclc:;,',,,,'..';:ccc:clllllloollccccc:;,''.......'''...',;coddxxkxxdxxxkkkkkkkkkkkk
// cccc:::;,...'',;,''';odolol:cldddc;clllllllc:;;lodoooooodxko;;:ldddoloddddxdc;,'....''.......',;looooodd:.....,:,.;loodl:;,',,,,'..',:cccccllllllllllcccc:;,'.''',;;;cccccccllllloooddddddooddddooooollc
// cc::::;;,...'',,;,'';cllcllllllool:cccccllc::;;;cllllooldxko;,:lddxocoddddddlc;,'....'....'',:lloooooodd:.....;dc,lkkxxo:;,',,,,'..',:cccccccllllllllccccc;'''',;:lccoxxxxxxxxxxxxxdddddddoooooolcc:::;;
// ::::::;;,...''',,,'.;loloooddolllc:;,,;:cc:;;;;,;clclolcoxko;,;lddxoclodddddlool:,.........,:looloooooddc.....,oc;okkkxo:;,',,,,'...,:clllcclllllllccllllc;'.'',:c:clddxxxxkkkxkkkxdooooolloooollc:::;;;
// ::::::;;,...''......;loooooooolllccccccll:''',,,;llclllcoxko;,;cdddoclodddddlokkdoc;'...',:lddolloooooddc.....,lc:dkkkko:;,'',,,'...,;clllccllllllccccllcc:,'.',;;,;clloooodddddddddddoollllcc:::;;,,'..
// ::::::;;,...''.',...,oxxddollccllllllllc:,..',,',cllcllloxko,,;cdddoclodddddloxkkkkxdoolodooooooooddooddc'....'c::dxdddl:;,'',,,'...,:cllcccccccccccccccc:;,'.............''',,,,,,,,,,''''''.'.........
// :::::;;;,...'..,;,..;oxdoc:;;;:::::::;,,'........''',:ccoxkl,',coddollooddddloxkkkkkkkdooooooooooodddoddc'.....''';;;,;;;;,'',,,'...,:cllcccccccccccc::::;,'..................'',,,,,,,,,,,'''''''''''''
// :::::;;;,..''..,'...;oxool:,',,'.................   ..;ldxko,',codddllooddddloxkkkkkkxdolollooooooooooooc'.....'',lodddl:;,'',,,''..,:clccccccccc:::::::;,,'...........',;;;:ccllloolccccllc:c::::coolll
// ;:::;;;,'..','.'...';oxdddl,....   ... ......   . ....;odkko,'':oddolcodddddooxkkkkkxxdooollodoollllllooc'.....:;,oxxxxl:;,''',,''..,:ccccccccc:::::::;;,,'.'...',;::::codxxxxxxdxxxoccccodddddddddxdodo
// ;::;;;;,'..','.....';oxxddc.        ..............',,':oxkkd,',:ooooccodddddoldkxxkxxxxdoollddollooc,,;cc'.....:;,oxxxdc:;,'''''''..,:ccccc::::::::::;;,,'.....,:codoooxkkkkkkkdolooollllldxxxxxxxxdlccl
// ;;;;;;,,'..','.....';oxxdd:.       ..,,''..':c,.';;'..'ldkkd;',:ooooccodddddoldkxxxkxxxdoollddlclcc;'..:c'.....:;,oxxxdc:;,'''''''..':ccc::::::::::;;;,,'.....':lodoodxkkkkkxxxxdolclolllldxxkkkxxdlcccc
// ;;;;;;,,'..',..''...;odddd:.       .:l,..'..,odll;';:,'cooxo;.,cooolccodddddolxkxxxxxxxdoollol::,......:c,.....;,;oxxxoc;;'...''.'..';::::::::::::;;;,,'......;codoloxkkkkxoollodoolcccc;;clllllllc:;;:l
// ;;;;;;,,...,,.......,lddool;..    .'oo,,lxdooxkkxooxkl;clllc,.,cooolccodddddooxxxxxxxxxdoolloc;'''.....','.......';;:;;;,,....'.....';:::::::::;;;;;;,'......,:loolldxxdxxdooooll:;,'.................',
// ;;;;;,,,...,,'.''...;lddoooo:..   .,dxodkkkkkkkkkkxddl:c:,,:,.,cooolclodddddooxxxxxxxxxdoolloc'....... ........,::::::;,,'...'''....';:::::;::;;;,,,,,.'....';coolldxxolodxxxdool;.     .....      .   .
// ;,,,,,,,'..;;,;,,'..;oxxdoooc'......cxkxxkkddkkkkxlclc'...:l;.,cooolccodddddooxxxxxxxxxdoolcll,.          .....',,',,,,,,,'...''....';::::::::;;,,,,''......,:lolloxxollllodddol;... .....'.....  ..    
// ,,,,,,,,...;;,,'''.';dkkxxxxdl,.....cxxdodd::dxkxxxxxxc;:oxd:';loool::odddddooxxxxxxxxxdoolcc:'.''''''.....   .........'''..........';:::::;;;;,,'''.......,;colcldxollllollolc,.  ......''..........   
// ,,,,,,,'..';;'''''.':dkkkkkkkkd:'..:dkkkxkkxdxkkkkkkkxo:;:lc;';ldool:codddddooxxxxxxxxxdooccooldddxxxxo;..      ....................,;;;;;;;;;,,''''......';cllcldxdooooooollc:'....',,',''..........   
// ,,,,,,,'...;,'...'.'cxkkkkkkkkkxo:;lxkkkkkkkkkxdollddll:''''.';loooc:lddddddodxxxxxxxxdolcldkkkkkkkkkkko'.        ................',;;;;;,,,,,''''''......,:cccldxxxdollllc:'......';;;;;,,'''',......  
// ,'''''''...;,......'cxkkkkkkkkxddoooodxkkxl:;,'...':lloc,....';loolc:lddddddodxxxxxxxxdoclxkkkkkkkkkkkkx:...      ......''''''''',,;;;;,,,,,,'''''''.....';:ccldkkkkdc;;;,,....',,,;:c::;,,,,,,,,'..... 
// ,'''''''...,'......':dkkkkkkkxoloodooloodooc:,.....;lool;.....,coolc:oddddddddxxxxxxxddoloxkkkkkkkkkkkkxc......  ..'''',,,,,,,,,,,;,,,,,,,'''''...''.....';:::codxxxd:,,,'.....,,;;;:lc:;;;;;;;;,,',::,.
// ,,'''''....,'......':xkkkkkkkdllooooolll:;:::;,,,,;:llll:.....,clll::oddddddddxxxxxoccc::coxxxkkkkkkkkkd;.........''''',,,,,,,,,,,'''''''''''''''........',;;::ccccccc::;'. .';:ccccclodollllllcccclddl'
// ,,'''......,,'','..'cxkkkkkkxllooooolooolc:,....;cllllllc,....':llc::oddddddddxxxxxdlcccodxxdodxxkkkkkkdlc:'...''............................,:c;........',;codocc:::::;'....,codddddddddddxddddoddddo:.
// ,''........','.....'cxkkkkkkdloooollllloooolc,.':lollccllc,...':lc:;coddddddodxxxxxxxdddxkkkkxkkkkkkkkkkkkkl. ..''...........................,;,'.     ...,:oddl::::::::'......,,,;;:::cccclc::;;,,;:;'.
// ''....... .''....'.'ckkkkkOkolooooc::clooololc::lllllc:cll:...';cc::cdddddddodxxxxxxxxxdodddxkkkkkkkkOOkkkxc...','.................   ...  ..''..      ..';coddoc:;;;;,'...,,.      ................;;..
// '........ .''...'..'lkkkkOOkolllllc:cllloolc:;cllccccc:cllc;'.';::::ldddddddodxxxxxxxxxdddoloxxxkkkkkkxoc;....'''....'..                  ..,,..       ..,;clllcc::;;;;....;c;.                 ......  
// '''.........'.''...'lxxxxddlccllllc:lllllll:;;;cccccc::clllc:,,;;:::ldddddddodxxxxxxxxxddddoodoc:::::;'..  ...''.....''...               ..','..        ..';:::::::;;:;..  ....       .  ...    ...     
// ..............'....':dddddol:cllllc:lllllll:::;:::cccc::cllllc,...',:looddddoxkxxkxxxxxddxdodo:'...'...  ...'''......''....           ..','''..           ....'',,,,''..                         ..     
// ....................:ddddddlclllllc::cccllc;,'.',,,,;:;;clllll:'....,;;,,;::coddxxxkkkxxxxolc;''..'.... ...''''.....'''''....................             .............                                 
// ....................;llllloooolllll:;::;,....     ....',cllllll::codkkoc:::;,,,,;codddddddl;'............''..'''..''''.'.'...........''.......           ...''...............                           
// .........         ..,:::::dkkkddooc:,'..               .:lllodxxxxkkkdddddddolccoxkkxl:;;;,,'..................'''.'''''.......'''',,,,,,,,,...   ....  ............''''.''.............................
//            ...... .':clllcloxkkkkxo:'.                 .:lldkOOOOkdddddxxdddddxkOOOOOkxolc;''................'''''''''''..'....',,,,;;;;;;;,'...';:cc;,....      ....''''''''''''''''',,,,''''..........
//      ..............';:ccccc::lxOOOkdc'.                .;dxkOOOOxl:lodddddddxkOOOOOOkxocc:,..................'''''''''''.''',,'',;;;;;;;;;,:olcoxxxkOkxc....      . ..,;,,,,,,,;,,,,,,,,,,,,,,''''''''',
//     ..............'',;:;'';ccldkOOOkxc. ........       .:dkkOOkdc;,:lloololloxxdlc:;,....................'',,''''''''''....,;:;,,;:::::;;',lxkkkkxxkOOkc....       ..,;::::::::::::;;;;,,,,,,,,,',,,,,,,
// .................'',,,,;,..',,;cdkOkkd;'',,,,,,,,,,''...cxkkxdoc:;;clllllcccllc:;..         .............;lddol:,'...........'''';::::::;.'cdkkxxkkOOOko'....    ..';cccccc:ccccccccccccc:;;,''',,;;;;;;
// ..................'''',,'..';:;,:dxkkxl,''',,,,,,;;;;;;lxOxl:cc:;;:ccccccccccc:::;,'...  ....;ll:..    ...',:ccoo:..    ........';:::::;,;lokklcoxkOOOkc.........':cllllllccllllllccc::;;,,'.....'',,,,,
// ....................','. .',:cc;;clodddc,,;:::;;;,,,'';lolcc:;;;;,;:::::;;;;;:::ccc::;,''''':dxxc.            .....     .........,;:::,..;oxxdodddxkkko,.........;ccccclllllolccc:;,,''........'''''''''
// ....................'..   .',;:,..,;:cllcccccccccc:::cccc:c:,,;:ccccccc::;;,,,;:cc::;;;;;;;;::::;,''....                 .....  ....,;,..:dkxdddddxxkxdc:'......';:::::ccccllc;;,,,,,,,,,,,,,,,,,'''''''
// ...................'..     ...... .....''',,,,,,;;,,,,,,''...;::ccccllllll:,'',,;;,''''',,,;;;;;;;;;;;;,'.                           ..',;lxkkkxxxxkkkkkkl'....,::cc::ccccccllllcccc:;;;,,,,,,,,,,,;'...
// .....................            ..';;;;,,'.................;::::::::::::cc:;;,,';::::;;;;:::;;::;;;;;;::'.....                        .''';:ldxkkkkkkxdo;...,;:cc::cccccccllllllllollcc::;;,''....,'.  
// ...................         .....''',;:cllllcccc::;;;;;;,,,;:::::::::;;;,,,,,,,'..',;;;;:::::::::::;;;,'.';:;;;,,,'''''.'........      .';:;,,,:ccccc:,'....';:::::::::ccccccccllllcc::,''''.......''.  
// ...............',,,...........'',,,,,'..';::::cccccc:;,'',;:::::::;;;;;;;;;;;;,'.........................,::::::::::::::::::::;'.'''...';:clc:,'.''...  ..':lolc;,,;;;::::::::::;,''....  ............. 
// ...............'',;;;,''................  ..............',;;;;;;;;;;;,,;;;;;;,,,,''''',,,''''''''''''...,,,,,,,,,,,,;;;;;;;;,,,;;::::::,'''''''..........,lllool:,''''.'',,,;;,'.       ............... 
// .........        ..............'........               ...''',,,,,,,,,,,,,,,,'''''''...'',,,,,,,''...  ..''',,,,,''',,,,,,'..';:ccccccc:;'''''''.........''''''''.......',,,,'..       .........   .... 
//  .....                       ..'',,,,,'.....              .............''''''''''''''.........          ..........''''''....,,,,,,;;;;;;;,'..''''''''''''''''''.....    .,;;;,.                   ..   .
//    ..                         ......',,'.....  .        .........................'..'''.....            .................. ..',,,,,,,,;;;;'....'''..........''..        .',,,,.                 ....   .
//                                       ...      ...............................................  ..... ....'''''''''''......',,,,,''',,,''........'''.....'....          ..''''..               .....   .
//          ..                                     ...........''..........''''..........''.......... .........'',,,,,,,,,,,''',,;;;,'.........................             ..'......              .....    
//   .                                                .........................'''''''.........................''''''''''''''''''''......................               .........''......         .......  
//    ..                                                        ..............................................''''''...................................              ............''''''...         ....''..
//      .                                                                      ............................................''''''''''''..............               .............''''''....            ....
//        .                                                                               ...................'''''''''...............'''''''''...                   ......................         ......''
//         .                                                                                      ..........'''''',,,,,,,,,,'''''''''............                  .......................    .....'';;;'. 
//                                                                                                           .........''''',,,,;;;;;,,''''''..                              ....................'',;:;'.   
//               WHO TOUCHA MY SPAGHET?                                                                                     ......''',,,,''..                                 ..................,;;;,'.     
//                                                                                                                                   ...                                        ............'',,'..        
//                                                                                                                                                                              ...............            
//                                                                                                                                                                               .                         
//                                                                                                                                                                                                         
//                                                                                                                                                                                                         
//                                                                                                                                                                                                         

using System;
using System.Collections.Generic;
using System.Reflection;
using System.Linq;
using System.IO;
using Fluint.Layer.Diagnostics;
using Fluint.Layer.DependencyInjection;
using Fluint.Layer.Miscellaneous;
using System.Diagnostics;

namespace Fluint.Layer
{
    // only used in implementation
    public class ModulesManager
    {
        public ModuleCollection ModuleCollection { get; private set; }

        public ModulesManager()
        {
            ModuleCollection = new ModuleCollection();
        }

        /// <summary>
        /// Loads the modules inside the file using System.Reflection
        /// </summary>
        /// <param name="modulesfolder">The path of the folder to be loaded.</param>
        public void LoadFolder(string modulesfolder)
        {
            var dllCount = 0;
            // Load the DLLs from the modules directory
            if (Directory.Exists(modulesfolder))
            {
                var files = Directory.GetFiles(modulesfolder);
                foreach (var file in files)
                {
                    // only loads *.dll
                    if (file.EndsWith(".dll"))
                    {
                        try
                        {
                            var assembly = Assembly.LoadFrom(Path.GetFullPath(file));
                            dllCount++;
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine(ex);
                        }
                    }
                }
            }
            else
            {
                throw new ArgumentException("module folder not found");
            }

            var watch = new Stopwatch();
            watch.Start();

            var interfaceType = typeof(IModule);
            // Fetch all types that implement the interface IModule and are a class
            var types = AppDomain.CurrentDomain.GetAssemblies()
                .SelectMany(a => GetTypes(a))
                .Where(p => interfaceType.IsAssignableFrom(p) && p.IsClass)
                .ToArray();

            static IEnumerable<Type> GetTypes(Assembly a)
            {
                foreach (var type in a.GetTypes())
                { 
                    yield return type;
                }
            }

            var table = new ConsoleTable();
            table.AddColumn(new[] { "Type Name", "Type Parent", "Assembly", "Initialization Mode"});

            foreach (var type in types)
            { 

                var parent = type.GetInterfaces()
                    .Where(x => x.GetInterfaces()
                    .FirstOrDefault() == interfaceType)
                    .FirstOrDefault();

                var initializationMethod = parent.GetCustomAttribute<InitializationAttribute>().InitializationMethod;
                switch (initializationMethod)
                {
                    case InitializationMethod.Scoped:
                        ModuleCollection.MapScoped(parent, type);
                        table.AddRow(type.FullName, parent.FullName, Path.GetFileName(type.Assembly.Location), "Scoped");
                        break;
                    case InitializationMethod.Singleton:
                        ModuleCollection.MapSingleton(parent, type);
                        table.AddRow(type.FullName, parent.FullName, Path.GetFileName(type.Assembly.Location), "Singleton");
                        break;
                    case InitializationMethod.Instanced:
                        ModuleCollection.AddInstanced(type);
                        table.AddRow(type.FullName, parent.FullName, Path.GetFileName(type.Assembly.Location), "Instanced");
                        break;
                }
            }
            watch.Stop();

            ConsoleHelper.WriteInfo(table.ToMarkDownString());
            ConsoleHelper.WriteWrappedHeader($"Loaded {types.Length} module from {dllCount} DLL in {modulesfolder} in {watch.ElapsedMilliseconds}ms. Instance Fingerprint: {GetHashCode()}");
        }
    }
}
